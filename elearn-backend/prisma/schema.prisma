datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  password  String
  avatar    String?
  role      Role     @default(STUDENT)
  xp        Int      @default(0)
  createdAt DateTime @default(now())
  answers   Answer[]
  viewedMaterials String[]   @default([])
  topicsCreated   Topic[]    @relation("TopicCreator")
  materialsCreated Material[] @relation("MaterialCreator")
  quizzesCreated  Quiz[]     @relation("QuizCreator")

  @@index([role])       // Індекс для фільтрації по ролі
  @@index([createdAt])  // Індекс для сортування по даті створення
}

enum Role {
  STUDENT
  EDITOR
  ADMIN
}

enum Category {
  Programming
  Mathematics
  Databases
  Networks
  WebDevelopment
  MobileDevelopment
  MachineLearning
  Security
  DevOps
  OperatingSystems
}

enum Status {
  Draft
  Published
}

model Topic {
  id          String     @id @default(cuid())
  slug        String     @unique
  name        String     // Fallback name (EN)
  nameJson    Json?      // {"UA": "...", "PL": "...", "EN": "..."}
  description String
  descJson    Json?      // {"UA": "...", "PL": "...", "EN": "..."}
  category    Category   @default(Programming)
  parentId    String?
  parent      Topic?     @relation("TopicTree", fields: [parentId], references: [id])
  children    Topic[]    @relation("TopicTree")
  materials   Material[]
  quizzes     Quiz[]
  status      Status     @default(Draft)
  publishedAt DateTime?
  createdById String?
  createdBy   User?      @relation("TopicCreator", fields: [createdById], references: [id], onDelete: SetNull)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @default(now()) @updatedAt

  @@index([category])
  @@index([parentId])
}

model Material {
  id        String       @id @default(cuid())
  title     String       // Fallback title (EN)
  titleJson Json?        // {"UA": "...", "PL": "...", "EN": "..."}
  type      MaterialType
  url       String?
  content   String?
  contentJson Json?      // {"UA": "...", "PL": "...", "EN": "..."} for text materials
  lang      Lang         @default(EN) // Primary language of material
  topic     Topic        @relation(fields: [topicId], references: [id])
  topicId   String
  views       Int        @default(0)
  status      Status     @default(Draft)
  publishedAt DateTime?
  createdById String?
  createdBy   User?      @relation("MaterialCreator", fields: [createdById], references: [id], onDelete: SetNull)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @default(now()) @updatedAt

  @@index([topicId])
}

enum Lang {
  UA
  PL
  EN
}

enum MaterialType {
  pdf
  video
  link
  text
}

model Quiz {
  id          String     @id @default(cuid())
  title       String     // Fallback title (EN)
  titleJson   Json?      // {"UA": "...", "PL": "...", "EN": "..."}
  durationSec Int        @default(60)
  topicId     String
  topic       Topic      @relation(fields: [topicId], references: [id], onDelete: Cascade)
  questions   Question[]
  status      Status     @default(Draft)
  publishedAt DateTime?
  createdById String?
  createdBy   User?      @relation("QuizCreator", fields: [createdById], references: [id], onDelete: SetNull)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @default(now()) @updatedAt

  @@index([topicId])
}

model Question {
  id            String     @id @default(cuid())
  text          String     // Fallback text (EN)
  textJson      Json?      // {"UA": "...", "PL": "...", "EN": "..."}
  explanation   String?
  explanationJson Json?    // {"UA": "...", "PL": "...", "EN": "..."}
  tags          String[]
  difficulty    Difficulty
  quizId     String
  quiz       Quiz       @relation(fields: [quizId], references: [id])
  options    Option[]
  answers    Answer[]

  @@index([quizId])
}

model Option {
  id         String   @id @default(cuid())
  text       String   // Fallback text (EN)
  textJson   Json?    // {"UA": "...", "PL": "...", "EN": "..."}
  correct    Boolean  @default(false)
  questionId String
  question   Question @relation(fields: [questionId], references: [id])
  answers    Answer[]

  @@index([questionId])
}

model Answer {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  questionId String
  question   Question @relation(fields: [questionId], references: [id])
  optionId   String?
  option     Option?  @relation(fields: [optionId], references: [id])
  isCorrect  Boolean
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([questionId])
  @@index([userId, questionId])  // Композитний індекс для швидкого пошуку відповідей користувача
  @@index([createdAt])           // Індекс для сортування за датою
}

enum Difficulty {
  Easy
  Medium
  Hard
}

model Payment {
  id         String   @id @default(cuid())
  userEmail  String
  amount     Int
  currency   String
  provider   String
  providerId String
  status     String
  createdAt  DateTime @default(now())
}

model InviteToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
}

// ============================================
// TRANSLATION MODELS
// ============================================

// UI переклади (кнопки, меню, повідомлення)
model UiTranslation {
  id           String   @id @default(cuid())
  key          String   @unique // "nav.dashboard", "quiz.title", etc.
  translations Json     // {"UA": "...", "PL": "...", "EN": "..."}
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now()) @updatedAt

  @@index([key])
}

// Щоденні цілі з перекладами
model DailyGoalTemplate {
  id           String   @id @default(cuid())
  category     String   // quiz, materials, learning, practice, review
  weight       Int      @default(1)
  translations Json     // {"UA": "...", "PL": "...", "EN": "..."}
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now()) @updatedAt
}

// Слабкі місця / рекомендації
model WeakSpotTemplate {
  id           String   @id @default(cuid())
  category     String   // algorithms, sql, oop, etc.
  weight       Int      @default(1)
  translations Json     // {topic: {UA,PL,EN}, advice: {UA,PL,EN}}
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now()) @updatedAt
}

// Досягнення
model AchievementTemplate {
  id           String   @id @default(cuid())
  code         String   @unique // "first_quiz", "week_streak", etc.
  icon         String   // emoji or icon name
  translations Json     // {name: {UA,PL,EN}, description: {UA,PL,EN}}
  xpReward     Int      @default(0)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now()) @updatedAt
}

// Категорії з перекладами
model CategoryTranslation {
  id        String   @id @default(cuid())
  category  Category @unique
  translations Json  // {"UA": "Програмування", "PL": "...", "EN": "..."}
}
